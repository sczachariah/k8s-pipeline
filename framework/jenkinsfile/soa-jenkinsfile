@Library('fmwk8s-pipeline-library') _


import com.oracle.fmwk8s.common.Cleanup
import com.oracle.fmwk8s.common.Common


pipeline {
    agent {
        kubernetes {
            label 'fmwk8s-test-infra-slave'
            namespace 'fmwk8s'
            inheritFrom 'fmwk8s-test-infra-slave'
        }
    }

    environment {
        RUN_SUFFIX = Common.getUniqueId(this)
        KUBECONFIG = credentials('admin.fmwk8s.kubeconfig')
        SOA_OPERATOR_NS = 'soa-operator-ns' + "-${RUN_SUFFIX}"
        SOA_OPERATOR_SA = 'default'
        SOA_OPERATOR_REL = "${RUN_SUFFIX}"
        SOA_DOMAIN_NAME = 'soainfra'
        SOA_DOMAIN_NS = 'soa-domain-ns' + "-${RUN_SUFFIX}"
        FMWK8S_NFS_HOME = "/scratch/u01/DockerVolume"
        NFS_DOMAIN_DIR = "${SOA_DOMAIN_NS}"
        NFS_DOMAIN_PATH = "${FMWK8S_NFS_HOME}/${NFS_DOMAIN_DIR}"
    }


    stages {
        stage('build and deploy soa operator') {
            steps {
                log('INFO', 'Starting SOA pipeline with unique runId ' + sh(returnStdout: true, script: 'echo ${RUN_SUFFIX}'))

                withCredentials([[$class          : 'UsernamePasswordMultiBinding', credentialsId: 'DockerHub',
                                  usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD'],
                                 [$class          : 'UsernamePasswordMultiBinding', credentialsId: 'sandeep.zachariah.docker',
                                  usernameVariable: 'DOCKER_USERNAME_CISYSTEM', passwordVariable: 'DOCKER_PASSWORD_CISYSTEM']]) {
                    container('dind') {
                        git branch: 'master',
                                credentialsId: 'sandeep.zachariah.ssh',
                                url: 'git@orahub.oraclecorp.com:tooling/soa-kubernetes-operator.git'

                        script {
                            try {
                                sh label: 'create operator namespace', script: '''
                                export KUBECONFIG=${KUBECONFIG}
                                kubectl create ns ${SOA_OPERATOR_NS}
                                #kubectl create sa ${SOA_OPERATOR_SA} -n ${SOA_OPERATOR_NS}
                                '''
                            }
                            catch (exc) {
                            }
                        }

                        script {
                            try {
                                sh label: 'create domain namespace', script: '''
                                export KUBECONFIG=${KUBECONFIG}
                                kubectl create ns ${SOA_DOMAIN_NS}
                                '''
                            }
                            catch (exc) {
                            }
                            finally {
                                sh label: 'initialize helm', script: '''
                                export KUBECONFIG=${KUBECONFIG}
                                helm init
                                '''
                            }
                        }

                        sh label: 'build soa operator image', script: '''							
                        docker login http://container-registry.oracle.com -u ${DOCKER_USERNAME_CISYSTEM} -p ${DOCKER_PASSWORD_CISYSTEM}
						
						docker pull container-registry.oracle.com/java/serverjre:latest
						docker tag container-registry.oracle.com/java/serverjre:latest store/oracle/serverjre:8
						
						docker pull fmw-cert-docker.dockerhub-den.oraclecorp.com/soaoperatorpoc/weblogic-kubernetes-operator:2.1
						docker tag fmw-cert-docker.dockerhub-den.oraclecorp.com/soaoperatorpoc/weblogic-kubernetes-operator:2.1 weblogic-kubernetes-operator:2.1
						

						docker build --build-arg https_proxy=$https_proxy -t soa-kubernetes-operator:2.1 --no-cache=true .
						'''

                        sh label: 'push soa operator image', script: '''
						docker tag soa-kubernetes-operator:2.1 cisystem.docker.oraclecorp.com/soa-kubernetes-operator:2.1
						docker login cisystem.docker.oraclecorp.com -u ${DOCKER_USERNAME_CISYSTEM} -p ${DOCKER_PASSWORD_CISYSTEM}
						docker push cisystem.docker.oraclecorp.com/soa-kubernetes-operator:2.1
                        '''

                        sh label: 'deploy soa operator', script: '''
						retVal=`echo \\`helm ls ${SOA_OPERATOR_REL}\\``

						if [[ !  -z  "$retVal" ]]; then
						    helm upgrade \
						        --reuse-values \
						        --set "domainNamespaces={$SOA_DOMAIN_NS}" \
						        --wait \
						        ${SOA_OPERATOR_REL} \
						        kubernetes/charts/soa-kubernetes-operator
						else
							helm install kubernetes/charts/soa-kubernetes-operator \
								--name ${SOA_OPERATOR_REL} \
								--set image=cisystem.docker.oraclecorp.com/soa-kubernetes-operator:2.1 \
								--namespace ${SOA_OPERATOR_NS} \
								--set serviceAccount=${SOA_OPERATOR_SA} \
								--set "domainNamespaces={}" \
								--wait
						fi
						'''

                        sh label: 'verify soa operator', script: '''
						kubectl get pods -n ${SOA_OPERATOR_NS}
						kubectl logs -n ${SOA_OPERATOR_NS} -c weblogic-operator deployments/weblogic-operator
						'''
                    }

                    container('jnlp') {
                        git branch: 'master',
                                credentialsId: 'sandeep.zachariah.ssh',
                                url: 'git@orahub.oraclecorp.com:fmw-platform-qa/fmw-k8s-pipeline.git'

                        sh label: 'create nfs folder', script: '''
                        export KUBECONFIG=${KUBECONFIG}
                        
                        cd kubernetes/framework
                        sed -i "s#%FMWK8S_NFS_HOME%#${FMWK8S_NFS_HOME}#g" fmwk8s-mkdir-pod.yaml
                        sed -i "s#%NFS_DOMAIN_DIR%#${NFS_DOMAIN_DIR}#g" fmwk8s-mkdir-pod.yaml
                        cat fmwk8s-mkdir-pod.yaml
                        
                        kubectl apply -f fmwk8s-mkdir-pod.yaml -n ${SOA_DOMAIN_NS}
                        '''
                    }
                }
            }
        }

        stage('prepare soa environment') {
            parallel {
                stage('setup database') {
                    steps {
                        withCredentials([[$class          : 'UsernamePasswordMultiBinding', credentialsId: 'DockerHub',
                                          usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD'],
                                         [$class          : 'UsernamePasswordMultiBinding', credentialsId: 'sandeep.zachariah.docker',
                                          usernameVariable: 'DOCKER_USERNAME_CISYSTEM', passwordVariable: 'DOCKER_PASSWORD_CISYSTEM']]) {
                            container('jnlp') {
                                git branch: 'master',
                                        credentialsId: 'sandeep.zachariah.ssh',
                                        url: 'git@orahub.oraclecorp.com:tooling/soa-kubernetes-operator.git'

                                sh label: 'setup env', script: '''
                                export KUBECONFIG=${KUBECONFIG}
                                '''

                                sh label: 'setup db', script: '''
                                retVal=`echo \\`kubectl get secret regcred -n ${SOA_DOMAIN_NS} 2>&1\\``
                                if echo "$retVal" | grep -q "not found"; then
                                    kubectl create secret docker-registry regcred -n ${SOA_DOMAIN_NS} --docker-server=http://container-registry.oracle.com \
                                    --docker-username=${DOCKER_USERNAME_CISYSTEM} --docker-password=${DOCKER_PASSWORD_CISYSTEM} --docker-email=${DOCKER_USERNAME_CISYSTEM}
                                fi
                       
                                cd kubernetes/samples/scripts/create-soa-domain/domain-home-on-pv/multiple-Managed-servers
                                cp soadb.yaml soadb.yaml.orig

						        sed -i "s#image: oracle/database:12.2.0.1#image: container-registry.oracle.com/database/enterprise:12.2.0.1-slim#g" soadb.yaml
						        sed -i "s#namespace: soans#namespace: ${SOA_DOMAIN_NS}#g" soadb.yaml
						        sed -i "s#terminationGracePeriodSeconds: 30#terminationGracePeriodSeconds: 30\\n      imagePullSecrets:\\n      - name: regcred#g" soadb.yaml
						        cat soadb.yaml

						        kubectl apply -f soadb.yaml
						        
						        dbstat='dbstat'
						        i=0
						        until `echo $dbstat | grep -q Running` > /dev/null
						        do
						            if [ $i == 25 ]; then
						                echo "Timeout waiting for DB. Exiting!!."
						                exit 1
						            fi
						            i=$((i+1))
						            echo "DB is not Running. Iteration $i of 25. Sleeping"
						            sleep 60
						            dbstat=`echo \\`kubectl get pods -n ${SOA_DOMAIN_NS} 2>&1 | grep soadb\\``
						        done
						        echo "DB container is Running."
						        sleep 300
						        
                                kubectl get pods,svc -n ${SOA_DOMAIN_NS} | grep soadb
						        kubectl logs soadb-0 -n ${SOA_DOMAIN_NS}
                                '''
                            }
                        }
                    }
                }

                stage('prepare soa domain in pv') {
                    steps {
                        withCredentials([[$class          : 'UsernamePasswordMultiBinding', credentialsId: 'DockerHub',
                                          usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD'],
                                         [$class          : 'UsernamePasswordMultiBinding', credentialsId: 'sandeep.zachariah.docker',
                                          usernameVariable: 'DOCKER_USERNAME_CISYSTEM', passwordVariable: 'DOCKER_PASSWORD_CISYSTEM']]) {
                            container('jnlp') {
                                sh label: 'setup env', script: '''
                                export KUBECONFIG=${KUBECONFIG}
                                sleep 120
                                '''

                                sh label: 'upgrade helm', script: '''
                                helm upgrade \
                                    --reuse-values \
                                    --set "domainNamespaces={$SOA_DOMAIN_NS}" \
                                    --wait \
                                    ${SOA_OPERATOR_REL} \
                                    kubernetes/charts/soa-kubernetes-operator
                                '''


                                sh label: 'configure domain secrets', script: '''
                                retVal=`echo \\`kubectl get secret ${SOA_DOMAIN_NAME}-weblogic-credentials -n ${SOA_DOMAIN_NS} 2>&1\\``
                                if echo "$retVal" | grep -q "not found"; then
                                    kubernetes/samples/scripts/create-soa-domain-credentials/create-domain-credentials.sh -u weblogic -p Welcome1 -n ${SOA_DOMAIN_NS} -d ${SOA_DOMAIN_NAME}
                                fi
                                '''

                                sh label: 'prepare persistent volume', script: '''
                                cd kubernetes/samples/scripts/create-soa-domain-pv-pvc
                                cp create-pv-pvc-inputs.yaml create-pv-pvc-inputs.yaml.orig

						        sed -i "s#baseName: domain#baseName: ${SOA_DOMAIN_NS}#g" create-pv-pvc-inputs.yaml
						        sed -i "s#domainUID: soainfra#domainUID: ${SOA_DOMAIN_NAME}#g" create-pv-pvc-inputs.yaml
						        sed -i "s#namespace: soans#namespace: ${SOA_DOMAIN_NS}#g" create-pv-pvc-inputs.yaml
						        sed -i "s#weblogicDomainStoragePath: /scratch/DockerVolume/SOA#weblogicDomainStoragePath: ${NFS_DOMAIN_PATH}#g" create-pv-pvc-inputs.yaml
						        sed -i "s#weblogicDomainStorageReclaimPolicy: Retain#weblogicDomainStorageReclaimPolicy: Recycle#g" create-pv-pvc-inputs.yaml
                                cat create-pv-pvc-inputs.yaml
                        
                                ./create-pv-pvc.sh -i create-pv-pvc-inputs.yaml -o ${WORKSPACE}/soa-operator-output-directory

                                cp ${WORKSPACE}/soa-operator-output-directory/pv-pvcs/${SOA_DOMAIN_NAME}-${SOA_DOMAIN_NS}-pv.yaml ${WORKSPACE}
						        cp ${WORKSPACE}/soa-operator-output-directory/pv-pvcs/${SOA_DOMAIN_NAME}-${SOA_DOMAIN_NS}-pvc.yaml ${WORKSPACE}
                                cat ${WORKSPACE}/${SOA_DOMAIN_NAME}-${SOA_DOMAIN_NS}-pv.yaml
						        cat ${WORKSPACE}/${SOA_DOMAIN_NAME}-${SOA_DOMAIN_NS}-pvc.yaml

                                kubectl apply -f ${WORKSPACE}/${SOA_DOMAIN_NAME}-${SOA_DOMAIN_NS}-pv.yaml -n ${SOA_DOMAIN_NS}
						        kubectl apply -f ${WORKSPACE}/${SOA_DOMAIN_NAME}-${SOA_DOMAIN_NS}-pvc.yaml -n ${SOA_DOMAIN_NS}

                                kubectl describe pv ${SOA_DOMAIN_NAME}-${SOA_DOMAIN_NS}-pv -n ${SOA_DOMAIN_NS}
                                kubectl describe pvc ${SOA_DOMAIN_NAME}-${SOA_DOMAIN_NS}-pvc -n ${SOA_DOMAIN_NS}
                                '''

                                sh label: 'prepare domain in pv', script: '''
                                cd kubernetes/samples/scripts/create-soa-domain/domain-home-on-pv/multiple-Managed-servers
                                cp create-domain-inputs.yaml create-domain-inputs.yaml.orig
                                cp create-domain-job-template.yaml create-domain-job-template.yaml.orig
                        
                                sed -i "s#domainUID: soainfra#domainUID: ${SOA_DOMAIN_NAME}#g" create-domain-inputs.yaml
                                sed -i "s#domainHome: /u01/oracle/user_projects/domains/soainfra#domainHome: /u01/oracle/user_projects/domains/${SOA_DOMAIN_NAME}#g" create-domain-inputs.yaml
                                sed -i "s#weblogicCredentialsSecretName: soainfra-domain-credentials#weblogicCredentialsSecretName: ${SOA_DOMAIN_NAME}-weblogic-credentials#g" create-domain-inputs.yaml
                                sed -i "s#image: oracle/soa:12.2.1.3#image: container-registry.oracle.com/middleware/soasuite:12.2.1.3#g" create-domain-inputs.yaml
                                sed -i "s/#imagePullSecretName:/imagePullSecretName: regcred/g" create-domain-inputs.yaml
                                sed -i "s#logHome: /u01/oracle/user_projects/domains/logs/soainfra#logHome: /u01/oracle/user_projects/domains/logs/${SOA_DOMAIN_NAME}#g" create-domain-inputs.yaml
                                #sed -i "s#exposeAdminT3Channel: false#exposeAdminT3Channel: true#g" create-domain-inputs.yaml
                                #sed -i "s/#t3PublicAddress:/t3PublicAddress: fmwk8s.us.oracle.com/g" create-domain-inputs.yaml
                                sed -i "s#namespace: soans#namespace: ${SOA_DOMAIN_NS}#g" create-domain-inputs.yaml
                                sed -i "s#persistentVolumeClaimName: soainfra-domain-pvc#persistentVolumeClaimName: ${SOA_DOMAIN_NAME}-${SOA_DOMAIN_NS}-pvc#g" create-domain-inputs.yaml
                                sed -i "s#initialManagedServerReplicas: 2#initialManagedServerReplicas: 1#g" create-domain-inputs.yaml
                                cat create-domain-inputs.yaml
                                
                                sed -i "s#soadb:1521#soadb.${SOA_DOMAIN_NS}:1521#g" create-domain-job-template.yaml
                                cat create-domain-job-template.yaml
                                '''
                            }
                        }
                    }
                }
            }
        }

        stage('deploy soa domain') {
            steps {
                sh label: 'create domain in pv', script: '''
                cd kubernetes/samples/scripts/create-soa-domain/domain-home-on-pv/multiple-Managed-servers
                ./create-domain.sh -i create-domain-inputs.yaml -o ${WORKSPACE}/soa-operator-output-directory
                
                cp ${WORKSPACE}/soa-operator-output-directory/soa-domains/${SOA_DOMAIN_NAME}/domain.yaml ${WORKSPACE}
                cat ${WORKSPACE}/domain.yaml
                '''

                sh label: 'start domain', script: '''
                kubectl apply -f ${WORKSPACE}/domain.yaml
                sleep 300
                
                kubectl get all,domains -n ${SOA_DOMAIN_NS}
                #kubectl logs ${SOA_DOMAIN_NAME}-adminserver -n ${SOA_DOMAIN_NS}
                '''
            }
        }

        stage('deploy test tools') {
            steps {
                sh label: 'setup env', script: '''
                '''

                sh label: 'deploy selenium', script: '''
                '''
            }
        }

        stage('run tests') {
            parallel {
                stage('verify soa ready') {
                    steps {
                        sh label: 'setup env', script: '''
                        '''
                    }
                }

                stage('execute tests') {
                    steps {
                        sh label: 'setup env vars', script: '''
                        '''

                        sh label: 'run test', script: '''
                        '''

                        sh label: 'publish results', script: '''
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            container(name: 'jnlp') {
                script {
                    Cleanup.cleanOperator("${SOA_OPERATOR_REL}")
                }
                script {
                    try {
                        sh label: 'clean domain pods and services', script: '''
                        kubectl delete jobs --all -n ${SOA_DOMAIN_NS}
                        kubectl delete services --all -n ${SOA_DOMAIN_NS}
                        kubectl delete pods --all -n ${SOA_DOMAIN_NS}
                        '''
                    }
                    catch (exc) {
                        echo "Cleanup domain pods and services failed!!"
                    }
                    finally {
                        sleep 10
                    }
                }
                script {
                    try {
                        sh label: 'clean domain configmap and stateful sets', script: '''
                        kubectl delete configmaps --all -n ${SOA_DOMAIN_NS}
                        kubectl delete statefulsets --all -n ${SOA_DOMAIN_NS}
                        '''
                    }
                    catch (exc) {
                        echo "Cleanup domain configmap and stateful sets failed!!"
                    }
                    finally {
                        sleep 30
                    }
                }
                script {
                    try {
                        sh label: 'clean domain resource', script: '''
                        kubectl delete domain ${SOA_DOMAIN_NAME} -n ${SOA_DOMAIN_NS}
                        '''
                    }
                    catch (exc) {
                        echo "Cleanup domain resource failed!!"
                    }
                    finally {
                        sleep 30
                    }
                }
                script {
                    try {
                        sh label: 'clean domain persistent volume', script: '''
                        kubectl delete pvc ${SOA_DOMAIN_NAME}-${SOA_DOMAIN_NS}-pvc -n ${SOA_DOMAIN_NS}
                        sleep 10
                        kubectl delete pv ${SOA_DOMAIN_NAME}-${SOA_DOMAIN_NS}-pv -n ${SOA_DOMAIN_NS}
                        '''
                    }
                    catch (exc) {
                        echo "Cleanup domain persistent volume failed!!"
                    }
                    finally {
                        sleep 10
                    }
                }
                script {
                    try {
                        sh label: 'clean domain namespace', script: '''
                        kubectl delete ns ${SOA_DOMAIN_NS}
                        '''
                    }
                    catch (exc) {
                        echo "Cleanup domain namespace failed!!"
                    }
                }
                script {
                    try {
                        sh label: 'clean soa operator', script: '''
                        helm delete --purge ${SOA_OPERATOR_REL}
                        '''
                    }
                    catch (exc) {
                        echo "Cleanup operator failed!!."
                    }
                    finally {
                        sleep 10
                        sh label: 'clean operator namespace', script: '''
                        kubectl delete configmaps --all -n ${SOA_OPERATOR_NS}
                        '''
                    }
                }
                script {
                    try {
                        sh label: 'clean operator namespace', script: '''
                        kubectl delete all --all -n ${SOA_OPERATOR_NS}
                        sleep 10
                        kubectl delete ns ${SOA_OPERATOR_NS}
                        '''
                    }
                    catch (exc) {
                        echo "Cleanup operator namespace failed!!."
                    }
                }
            }
        }
    }
}
