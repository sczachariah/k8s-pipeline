@Library('fmwk8s-pipeline-library') _


import com.oracle.fmwk8s.common.Common
import com.oracle.fmwk8s.common.EnvironmentSetup
import com.oracle.fmwk8s.common.Initializer
import com.oracle.fmwk8s.common.Validation
import com.oracle.fmwk8s.env.*
import com.oracle.fmwk8s.test.Functional

pipeline {
    agent {
        kubernetes {
            label 'fmwk8s-slave'
            namespace 'fmwk8s'
            yamlFile 'framework/yaml/fmwk8s-slave.yaml'
        }
    }

    environment {
        RUN_SUFFIX = Common.getUniqueId(this, "${PRODUCT_NAME}")
        REGISTRY_AUTH = credentials("sandeep.zachariah.docker")
        OPERATOR_NS = "${DOMAIN_NAME}-operator-ns-${RUN_SUFFIX}"
        OPERATOR_SA = 'default'
        OPERATOR_HELM_RELEASE = "op-${RUN_SUFFIX}"
        DOMAIN_NAME = Common.getDomainName("${PRODUCT_NAME}")
        DOMAIN_NS = "${DOMAIN_NAME}-domain-ns-${RUN_SUFFIX}"
        WEBLOGIC_USER = 'weblogic'
        ADMIN_PASSWORD = 'Welcome1'
        FMWK8S_NFS_HOME = "/scratch/u01/DockerVolume/domains"
        NFS_DOMAIN_DIR = "${DOMAIN_NS}"
        NFS_DOMAIN_PATH = "${FMWK8S_NFS_HOME}/${NFS_DOMAIN_DIR}"
        LB_HELM_RELEASE = "lb-${RUN_SUFFIX}"
    }


    stages {
        stage('initialize validation framework') {
            steps {
                log('INFO', 'Starting E2E pipeline for ' + "${PRODUCT_NAME}" + ' with unique runId ' + "${RUN_SUFFIX}")

                container('jnlp') {
                    script {
                        Initializer.initialize(this)
                    }
                }
            }
        }

        stage('validate input parameters') {
            steps {
                container('jnlp') {
                    script {
                        Validation.validateInputs(this, "${OPERATOR_VERSION}", "${PRODUCT_NAME}", "${DOMAIN_TYPE}", "${DATABASE_VERSION}", "${TEST_IMAGE_TAG}", "${TEST_TYPE}", "${HOURS_AFTER}")
                        sleep 1
                    }
                }
            }
        }

        stage('deploy kubernetes operator') {
            steps {
                container('jnlp') {
                    dir('weblogic-operator') {
                        script {
                            Operator.deployOperator(this, "${OPERATOR_VERSION}", "${OPERATOR_HELM_RELEASE}", "${OPERATOR_NS}", "${OPERATOR_SA}", "${ELK_ENABLE}")
                        }
                    }
                }

                container('jnlp') {
                    script {
                        Domain.createNamespace(this, "${DOMAIN_NS}")
                        Common.configureRegistrySecret(this, "${DOMAIN_NS}", "${REGISTRY_AUTH_USR}", "${REGISTRY_AUTH_PSW}")
                        EnvironmentSetup.createNfsFolder(this, "${DOMAIN_NS}", "${FMWK8S_NFS_HOME}", "${NFS_DOMAIN_DIR}")
                    }
                }
            }
        }

        stage('prepare fmw product environment') {
            parallel {
                stage('setup database') {
                    steps {
                        container('jnlp') {
                            dir('fmwk8s') {
                                script {
                                    Database.deployDatabase(this, "${DATABASE_VERSION}", "${DOMAIN_NS}")
                                    Domain.preparRcu(this, "${PRODUCT_IMAGE_TAG}", "${DOMAIN_NAME}", "${DOMAIN_NS}")
                                }
                            }
                        }
                    }
                }
                stage('prepare fmw domain in pv') {
                    steps {
                        container('jnlp') {
                            dir('fmwsamples') {
                                script {
                                    Domain.pullSampleScripts(this)

                                    Operator.setDomainNamespace(this, "${OPERATOR_HELM_RELEASE}", "${DOMAIN_NS}")
                                    Domain.configureDomainSecret(this, "${DOMAIN_NAME}", "${DOMAIN_NS}")
                                    Domain.configureRcuSecret(this, "${DOMAIN_NAME}", "${DOMAIN_NS}")
                                    Domain.preparePersistentVolume(this, "${DOMAIN_NAME}", "${DOMAIN_NS}", "${NFS_DOMAIN_PATH}")
                                    Domain.prepareDomain(this, "${PRODUCT_IMAGE_TAG}", "${DOMAIN_NAME}", "${DOMAIN_NS}")
                                }
                            }
                        }
                    }

                }
            }
        }

        stage('deploy fmw domain') {
            parallel {
                stage('create fmw domain') {
                    steps {
                        container('jnlp') {
                            dir('fmwsamples') {
                                script {
                                    Domain.createDomain(this, "${DOMAIN_NAME}", "${DOMAIN_NS}")
                                    Logging.deployLogstash(this, "${ELK_ENABLE}", "${DOMAIN_NAME}", "${DOMAIN_NS}")
                                }
                            }
                        }
                    }
                }
                stage('configure domain loadbalancer') {
                    steps {
                        container('jnlp') {
                            dir('fmwsamples') {
                                script {
                                    IngressController.deployLoadBalancer(this, "${K8S_LOADBALANCER}", "${LB_HELM_RELEASE}", "${DOMAIN_NS}")
                                    sleep(60)
                                    Domain.configureDomainLoadBalancer(this, "${DOMAIN_NAME}", "${DOMAIN_NS}")
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('verify domain ready') {
            steps {
                container('jnlp') {
                    sh label: 'verify weblogic ready', script: '''
                            echo "TODO WEBLOGIC READY"
                            '''
                }
            }
        }

        stage('run tests') {
            parallel {
                stage('wait for completion') {
                    steps {
                        container('jnlp') {
                            script {
                                EnvironmentSetup.waitHoursAfter(this, "${HOURS_AFTER}")
                            }
                        }
                    }
                }

                stage('execute tests') {
                    steps {
                        container('jnlp') {
                            script {
                                Functional.invokeTest(this, "${TEST_TYPE}", "${TEST_IMAGE_TAG}")
                            }
                        }
                    }
                }
            }
        }

        stage('publish results') {
            steps {
                container('jnlp') {
                    script {
                        Common.publishLogs(this)
                    }
                }
            }
        }
    }

    post {
        always {
            container(name: 'jnlp') {
                script {
                    currentBuild.displayName = this.env.OPERATOR_VERSION + "-" + this.env.PRODUCT_NAME

                    Logging.getEventLogs(this, "${OPERATOR_NS}")
                    Logging.getEventLogs(this, "${DOMAIN_NS}")
                    Logging.fetchDomainLogs(this, "${DOMAIN_NAME}", "${DOMAIN_NS}")
                    Logging.fetchTestLogs(this, "${DOMAIN_NS}")
                    Logging.archiveLogs(this)

                    Operator.cleanOperator this, "${OPERATOR_HELM_RELEASE}"

                    IngressController.undeployLoadBalancer this, "${LB_HELM_RELEASE}"
                    Domain.cleanDomain this, "${DOMAIN_NAME}", "${DOMAIN_NS}"
                    EnvironmentSetup.deleteNfsFolder(this, "${DOMAIN_NS}", "${FMWK8S_NFS_HOME}", "${NFS_DOMAIN_DIR}")
                    Domain.cleanDomainNamespace this, "${DOMAIN_NS}"

                    Operator.cleanOperator this, "${OPERATOR_HELM_RELEASE}"
                    Operator.cleanOperatorNamespace this, "${OPERATOR_NS}"
                }
            }
        }
    }
}
